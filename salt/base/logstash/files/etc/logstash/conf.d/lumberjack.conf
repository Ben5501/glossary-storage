{% from 'settings/init.sls' import settings with context %}
{%- for environment, environment_details in pillar.environments.items() %}
input {
    file {
        path              => "/data/shop/{{environment}}/current/data/common/lumberjack/lumberjack-*"
        format            => "json"
        discover_interval => 5
        tags              => ["yzed", "{{environment}}"]
    }
}
{% endfor %}

filter {
    if "yzed" in [tags] {
        date {
            match => [ "dateAndTime", "ISO8601" ]
        }
    }
}

output {
  if "yzed" in [tags] {
{%- for environment, environment_details in pillar.environments.items() %}
    if "{{environment}}" in [tags] {
      elasticsearch_http {
        host => "{{ settings.hosts.elasticsearch_data|first }}"
        index => "lumberjack_{{environment}}_%{+YYYY-MM-dd}"
      }
    }
{% endfor%}
  }
}
