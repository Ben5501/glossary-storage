server {
  listen        443 ssl spdy;
  server_name   {{ pillar.kibana.hostname }};

  root          /var/www;
  access_log    /data/logs/kibana-proxy-access.log extended;

  ssl                   on;
  ssl_certificate       /etc/nginx/ssl/kibana.crt;
  ssl_certificate_key   /etc/nginx/ssl/kibana.key;
  ssl_protocols         SSLv3 TLSv1;

  # Proxy setup - 10 minutes of timeout
  proxy_connect_timeout 600;
  proxy_read_timeout 600;
  proxy_send_timeout 600;
  client_body_timeout 600;
  client_header_timeout 600;
  send_timeout 600;

  # Kibana
  location / {
    proxy_pass http://127.0.0.1:9292;
    proxy_set_header  Host $http_host;
    proxy_set_header  Authorization "";
    proxy_set_header  X-Forwarded-Proto https;
  }

  # ES proxies
  location ~ ^/_aliases$ {
    proxy_pass http://127.0.0.1:9200;
    proxy_read_timeout 90;
  }
  location ~ ^/.*/_aliases$ {
    proxy_pass http://127.0.0.1:9200;
    proxy_read_timeout 90;
  }
  location ~ ^/_nodes$ {
    proxy_pass http://127.0.0.1:9200;
    proxy_read_timeout 90;
  }
  location ~ ^/.*/_search$ {
    proxy_pass http://127.0.0.1:9200;
    proxy_read_timeout 90;
  }
  location ~ ^/.*/_mapping {
    proxy_pass http://127.0.0.1:9200;
    proxy_read_timeout 90;
  }

  # Password protected end points
  location ~ ^/kibana-int/dashboard/.*$ {
    proxy_pass http://127.0.0.1:9200;
    proxy_read_timeout 90;
    limit_except GET {
      proxy_pass http://127.0.0.1:9200;
    }
  }
  location ~ ^/kibana-int/temp.*$ {
    proxy_pass http://127.0.0.1:9200;
    proxy_read_timeout 90;
    limit_except GET {
      proxy_pass http://127.0.0.1:9200;
    }
  }

  # Authorization - allow ProjectNet without password, public access with password
  satisfy   any;
  allow   10.0.0.0/8;
  allow   127.0.0.0/8;

  auth_basic "Restricted Files";
  auth_basic_user_file /etc/nginx/htpasswd-kibana;
}